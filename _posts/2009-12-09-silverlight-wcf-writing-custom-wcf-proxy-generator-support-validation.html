---
layout: post
title: 'Silverlight / WCF : Writing your own Custom WCF Proxy Generator to support
  validation'
tags:
- Custom
- Generator
- Proxy
- Silverlight
- Wcf
---

Working on the data validation section of different projects in Silverlight we usually have to face the standard problem: basically in Silverlight 3 the data validation framework relies on exceptions thrown in the setter of objects properties.<br /><br />In a real-world application our data will surely come from a Web Service (we are not using RIA Services yet), if we do not have control over the service itself we are forced to use the proxy classes generated by svcutil or Visual Studio as part of our domain model.<br /><br />The main problem is we do not have huge control over the classes that are generated by the standard WCF Proxy Generator that Visual Studio provide, and the classes it generates are pretty simple (they only support the INotifyPropertyChanged interface).<br /><br />Using the RIA services framework can help solving the validation problem because the proxy classes it generate have a richer set of functionalities built in.<br /><br />However if we are stuck with plain WCF services we have several ways to overcome this problem and add validation logic (or any other business logic) to these classes.<br /><br />One of the possible approach (not the simplest one I have to admit) is to write you own WCF Proxy Class Generator and alter the code that the standard generator provide; I had this idea looking at this post that explains the basis of customizing the generator: <a href="http://blogs.msdn.com/pedram/archive/2007/08/10/customising-wcf-proxy-generation-in-visual-studio-2008.aspx">Customizing WCF Proxy Generation in Visual Studio 2008</a>.<br /><br />For a first implementation we want to be able to generate a class like this:
<div id="codeSnippetWrapper" class="csharpcode-wrapper">
<div id="codeSnippet" class="csharpcode">
<pre class="alt"><span id="lnum1" class="lnum">   1:</span> [System.Diagnostics.DebuggerStepThroughAttribute()]</pre>

<pre class="alteven"><span id="lnum2" class="lnum">   2:</span> [System.CodeDom.Compiler.GeneratedCodeAttribute(<span class="str">"System.Runtime.Serialization"</span>, <span class="str">"3.0.0.0"</span>)]</pre>
<code></code>
<pre class="alt"><span id="lnum3" class="lnum">   3:</span> [System.Runtime.Serialization.DataContractAttribute(Name=<span class="str">"CompositeType"</span>, Namespace=<span class="str">"http://schemas.datacontract.org/2004/07/MusicStore.WebService"</span>)]</pre>

<pre class="alteven"><span id="lnum4" class="lnum">   4:</span> <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> CompositeType : <span class="kwrd">object</span>, System.ComponentModel.INotifyPropertyChanged {</pre>

<pre class="alt"><span id="lnum5" class="lnum">   5:</span></pre>

<pre class="alteven"><span id="lnum6" class="lnum">   6:</span>     <span class="kwrd">private</span> <span class="kwrd">bool</span> BoolValueField;</pre>

<pre class="alt"><span id="lnum7" class="lnum">   7:</span></pre>

<pre class="alteven"><span id="lnum8" class="lnum">   8:</span>     <span class="kwrd">private</span> <span class="kwrd">string</span> StringValueField;</pre>

<pre class="alt"><span id="lnum9" class="lnum">   9:</span></pre>

<pre class="alteven"><span id="lnum10" class="lnum">  10:</span>     <span class="kwrd">partial</span> <span class="kwrd">void</span> ValidateProperty(<span class="kwrd">string</span> propertyName, <span class="kwrd">object</span> <span class="kwrd">value</span>);</pre>

<pre class="alt"><span id="lnum11" class="lnum">  11:</span></pre>

<pre class="alteven"><span id="lnum12" class="lnum">  12:</span>     [System.Runtime.Serialization.DataMemberAttribute()]</pre>

<pre class="alt"><span id="lnum13" class="lnum">  13:</span>     <span class="kwrd">public</span> <span class="kwrd">bool</span> BoolValue {</pre>

<pre class="alteven"><span id="lnum14" class="lnum">  14:</span>         get {</pre>

<pre class="alt"><span id="lnum15" class="lnum">  15:</span>             <span class="kwrd">return</span> <span class="kwrd">this</span>.BoolValueField;</pre>

<pre class="alteven"><span id="lnum16" class="lnum">  16:</span>         }</pre>

<pre class="alt"><span id="lnum17" class="lnum">  17:</span>         set {</pre>

<pre class="alteven"><span id="lnum18" class="lnum">  18:</span>             <span class="kwrd">this</span>.ValidateProperty(<span class="str">"BoolValue"</span>, <span class="kwrd">value</span>);</pre>

<pre class="alt"><span id="lnum19" class="lnum">  19:</span>             <span class="kwrd">if</span> ((<span class="kwrd">this</span>.BoolValueField.Equals(<span class="kwrd">value</span>) != <span class="kwrd">true</span>)) {</pre>

<pre class="alteven"><span id="lnum20" class="lnum">  20:</span>                 <span class="kwrd">this</span>.BoolValueField = <span class="kwrd">value</span>;</pre>

<pre class="alt"><span id="lnum21" class="lnum">  21:</span>                 <span class="kwrd">this</span>.RaisePropertyChanged(<span class="str">"BoolValue"</span>);</pre>

<pre class="alteven"><span id="lnum22" class="lnum">  22:</span>             }</pre>

<pre class="alt"><span id="lnum23" class="lnum">  23:</span>         }</pre>

<pre class="alteven"><span id="lnum24" class="lnum">  24:</span>     }</pre>

<pre class="alt"><span id="lnum25" class="lnum">  25:</span>     ...</pre>
</div>
</div>
The key points here are lines 10 and 18: we ‘declare’ a partial method and we use it to validate the property value before assigning it. Partial methods are very useful especially for code generators and designers, because if you do not provide an implementation in a partial class they are removed at compile time (that is the method declaration and its usage disappear).<br /><br />We chose this approach to leave you the freedom to implement the validation rules the way you like most.<br /><br />To extend the WCF Proxy Generator we basically have to inherit from the WCFProxyGenerator class and override the CallCodeGeneratorExtensions(CodeCompileUnit compileUnit), here we have access to the CodeDom representation of the class that was generated, we can then inspect it looking for the business entity classes (those that directly inherit from object) and, playing with the CodeDom classes, modify them adding the partial method declaration and the method call:
<div id="codeSnippetWrapper" class="csharpcode-wrapper">
<div id="codeSnippet" class="csharpcode">
<pre class="alt">[GuidAttribute(<span class="str">"64205D39-7D51-4c6d-8C0F-237E6FE2BD70"</span>)]</pre>

<pre class="alteven"><span class="kwrd">public</span> <span class="kwrd">class</span> StructuraWcfProxyGenerator : WCFProxyGenerator</pre>

<pre class="alt">{</pre>

<pre class="alteven">   <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> CallCodeGeneratorExtensions(CodeCompileUnit compileUnit)</pre>

<pre class="alt">   {</pre>

<pre class="alteven">      <span class="kwrd">base</span>.CallCodeGeneratorExtensions(compileUnit);</pre>



<pre class="alteven">      <span class="rem">// find all classes that inherit from ClientBase (all proxies)</span></pre>

<pre class="alt">      var proxies = FindAllProxyClasses(compileUnit);</pre>

<pre class="alteven">      <span class="rem">// add impersonation code to their constructors</span></pre>

<pre class="alt">      <span class="kwrd">foreach</span> (CodeTypeDeclaration proxy <span class="kwrd">in</span> proxies)</pre>

<pre class="alteven">      {</pre>

<pre class="alt">         AddPartialMethods(proxy);</pre>

<pre class="alteven">         AddValidationToProperties(proxy);</pre>

<pre class="alt">      }</pre>

<pre class="alteven">   }</pre>



<pre class="alteven">   <span class="kwrd">protected</span> <span class="kwrd">virtual</span> CodeTypeDeclarationCollection FindAllProxyClasses(CodeCompileUnit compileUnit)</pre>

<pre class="alt">   {</pre>

<pre class="alteven">      CodeTypeDeclarationCollection result = <span class="kwrd">new</span> CodeTypeDeclarationCollection();</pre>



<pre class="alteven">      <span class="rem">// search for all the proxy class (the one that inherits from ClientBase)</span></pre>

<pre class="alt">      <span class="kwrd">foreach</span> (CodeNamespace ns <span class="kwrd">in</span> compileUnit.Namespaces)</pre>

<pre class="alteven">      {</pre>

<pre class="alt">         <span class="kwrd">foreach</span> (CodeTypeDeclaration type <span class="kwrd">in</span> ns.Types)</pre>

<pre class="alteven">         {</pre>

<pre class="alt">            <span class="rem">// does this type inherit from ClientBase?</span></pre>

<pre class="alteven">            <span class="kwrd">if</span> (type.IsClass &amp;&amp; type.IsPartial)</pre>

<pre class="alt">            {</pre>

<pre class="alteven">               <span class="kwrd">foreach</span> (CodeTypeReference baseType <span class="kwrd">in</span> type.BaseTypes)</pre>

<pre class="alt">               {</pre>

<pre class="alteven">                  <span class="kwrd">if</span> (baseType.BaseType == <span class="str">"System.Object"</span>)</pre>

<pre class="alt">                  {</pre>

<pre class="alteven">                     <span class="rem">// we have found the proxy!</span></pre>

<pre class="alt">                     result.Add(type);</pre>

<pre class="alteven">                     <span class="kwrd">break</span>;</pre>

<pre class="alt">                  }</pre>

<pre class="alteven">               }</pre>

<pre class="alt">            }</pre>

<pre class="alteven">         }</pre>

<pre class="alt">      }</pre>

<pre class="alteven">      <span class="kwrd">return</span> result;</pre>

<pre class="alt">   }</pre>



<pre class="alt">   <span class="kwrd">protected</span> <span class="kwrd">virtual</span> <span class="kwrd">void</span> AddPartialMethods(CodeTypeDeclaration type)</pre>

<pre class="alteven">   {</pre>

<pre class="alt">      IVsSingleFileGenerator ivs = (IVsSingleFileGenerator)<span class="kwrd">this</span>;</pre>

<pre class="alteven">      <span class="rem">// ugly, but it's the only way I found to identify the language used</span></pre>

<pre class="alt">      <span class="kwrd">string</span> ext;</pre>

<pre class="alteven">      ivs.DefaultExtension(<span class="kwrd">out</span> ext);</pre>

<pre class="alt">      CodeSnippetTypeMember literalMember;</pre>

<pre class="alteven">      <span class="kwrd">if</span> (ext.Contains(<span class="str">"cs"</span>))</pre>

<pre class="alt">      {</pre>

<pre class="alteven">         <span class="rem">// csharp</span></pre>

<pre class="alt">         literalMember = <span class="kwrd">new</span> CodeSnippetTypeMember(</pre>

<pre class="alteven">            <span class="str">"partial void ValidateProperty(string propertyName, object value);"</span>);</pre>

<pre class="alt">      }</pre>

<pre class="alteven">      <span class="kwrd">else</span></pre>

<pre class="alt">      {</pre>

<pre class="alteven">         <span class="rem">// vb </span></pre>

<pre class="alt">         literalMember = <span class="kwrd">new</span> CodeSnippetTypeMember(</pre>

<pre class="alteven">            <span class="str">"Partial Sub ValidateProperty(byval propertyName as String, byval value as Object)"</span>);</pre>

<pre class="alt">      }</pre>

<pre class="alteven">      type.Members.Add(literalMember);</pre>

<pre class="alt">   }</pre>



<pre class="alt">   <span class="kwrd">protected</span> <span class="kwrd">virtual</span> <span class="kwrd">void</span> AddValidationToProperties(CodeTypeDeclaration type)</pre>

<pre class="alteven">   {</pre>

<pre class="alt">      <span class="kwrd">foreach</span> (CodeTypeMember member <span class="kwrd">in</span> type.Members)</pre>

<pre class="alteven">      {</pre>

<pre class="alt">         CodeMemberProperty ctor = member <span class="kwrd">as</span> CodeMemberProperty;</pre>

<pre class="alteven">         <span class="kwrd">if</span> (ctor != <span class="kwrd">null</span>)</pre>

<pre class="alt">         {</pre>

<pre class="alteven">            <span class="rem">// create a code statement like:</span></pre>

<pre class="alt">            <span class="rem">// this.ValidateProperty("Title", value)</span></pre>

<pre class="alteven">            CodeMethodInvokeExpression method = <span class="kwrd">new</span> CodeMethodInvokeExpression(</pre>

<pre class="alt">                <span class="kwrd">new</span> CodeThisReferenceExpression(),</pre>

<pre class="alteven">                <span class="str">"ValidateProperty"</span>,</pre>

<pre class="alt">               <span class="kwrd">new</span> CodeExpression[] {</pre>

<pre class="alteven">                  <span class="kwrd">new</span> CodePrimitiveExpression(ctor.Name),</pre>

<pre class="alt">                  <span class="kwrd">new</span> CodePropertySetValueReferenceExpression()</pre>

<pre class="alteven">               });</pre>



<pre class="alteven">            <span class="rem">// we got a constructor</span></pre>

<pre class="alt">            ctor.SetStatements.Insert(0, <span class="kwrd">new</span> CodeExpressionStatement(method));</pre>

<pre class="alteven">         }</pre>

<pre class="alt">      }</pre>

<pre class="alteven">   }</pre>

<pre class="alt">}</pre>
</div>
</div>
The tricky part here is the AddPartialMethods() function: the CodeDom do not have support for partial methods so, we have to provide the full string with the method signature.<br /><br />To use this extension you have to do 4 things:

1- compile the project and deploy the signed assembly to the GAC

2- double click the attached .reg file to register the extension in Visual Studio 2008

3- add a Service Reference to your project

4- navigate to the Reference.svcmap file and change the custom tool to use the brand new ‘Structura WCF Proxy Generator’ (the name must match the keys added in the reg file), optionally rerun the tool.<br /><br /><a href="/UserFiles/Guardian/2009/12/WCFProxyGeneratorCustomTool.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="WCFProxyGeneratorCustomTool" src="/UserFiles/Guardian/2009/12/WCFProxyGeneratorCustomTool_thumb.png" border="0" alt="WCFProxyGeneratorCustomTool" width="236" height="244" /></a>

Then you can just implement the partial method in your partial class to throw an exception in the setter if the value violate your client-side validation rule, this way you get the standard validation framework to work with proxy generated classes:
<div id="codeSnippetWrapper" class="csharpcode-wrapper">
<div id="codeSnippet" class="csharpcode">
<pre class="alt"><span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Album</pre>

<pre class="alteven">  {</pre>

<pre class="alt">     <span class="preproc">#region</span> <span class="str">"exception validation methods"</span></pre>



<pre class="alt">     <span class="kwrd">partial</span> <span class="kwrd">void</span> ValidateProperty(<span class="kwrd">string</span> propertyName, <span class="kwrd">object</span> <span class="kwrd">value</span>)</pre>

<pre class="alteven">     {</pre>

<pre class="alt">        <span class="rem">// Validator.ValidateProperty(value, new ValidationContext(this, null, null) { MemberName = propertyName });</span></pre>

<pre class="alteven">        <span class="kwrd">switch</span> (propertyName)</pre>

<pre class="alt">        {</pre>

<pre class="alteven">           <span class="kwrd">case</span> <span class="str">"Title"</span>:</pre>

<pre class="alt">              <span class="kwrd">if</span> (!ValidateTitle(<span class="kwrd">value</span>))</pre>

<pre class="alteven">                 <span class="kwrd">throw</span> <span class="kwrd">new</span> SystemException(<span class="str">"The field is Required"</span>);</pre>

<pre class="alt">              <span class="kwrd">break</span>;</pre>

<pre class="alteven">           <span class="kwrd">case</span> <span class="str">"PublicationDate"</span>:</pre>

<pre class="alt">              <span class="kwrd">if</span> (!ValidatePublicationDate(<span class="kwrd">value</span>))</pre>

<pre class="alteven">                 <span class="kwrd">throw</span> <span class="kwrd">new</span> SystemException(<span class="str">"Invalid date (must be &gt; 1900)"</span>);</pre>

<pre class="alt">              <span class="kwrd">break</span>;</pre>

<pre class="alteven">        }</pre>

<pre class="alt">     }</pre>

<pre class="alteven">...</pre>
</div>
</div>
This isn’t the cleanest solution in the world, but we can easily use this project as a base to add the full support for validation using the new data annotations.<br /><br />Side note: if you want to create your own custom WCF Proxy Generator you need the reference to some assemblies related to visual studio that are actually deployed in the GAC, I haven’t found any way to add them using the Visual Studio designers and I had to edit the project file in the Notepad and add the following references manually:
<div id="codeSnippetWrapper" class="csharpcode-wrapper">
<div id="codeSnippet" class="csharpcode">
<pre class="alt">&lt;Reference Include=<span class="str">"envdte, Version=8.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> /&gt;</pre>
<pre class="alteven">&lt;Reference Include=<span class="str">"Microsoft.VisualStudio.Editors, Version=9.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> /&gt;</pre>
<pre class="alt">&lt;Reference Include=<span class="str">"Microsoft.VisualStudio.OLE.Interop, Version=7.1.40304.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> /&gt;</pre>
<pre class="alteven">&lt;Reference Include=<span class="str">"Microsoft.VisualStudio.Shell.Interop, Version=7.1.40304.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> /&gt;</pre>
<pre class="alt">&lt;Reference Include=<span class="str">"Microsoft.VisualStudio.Shell.Interop.8.0, Version=8.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> /&gt;</pre>
</div>
</div>
Sample project:
<div id="scid:8eb9d37f-1541-4f29-b6f4-1eea890d4876:31e45a1f-bf43-4dcb-aead-e3c8d19a29f8" class="wlWriterEditableSmartContent" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
<div><a href="/UserFiles/Guardian/2009/12/Structura.WCF_.StructuraWcfProxyGenerator.zip" target="_self">Structura.WCF.StructuraWcfProxyGenerator.zip</a></div>
</div>
<br /><h2>Related Content</h2><ul><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/silverlight-wcf-fixing-custom-wcf-proxy-generator">Silverlight / WCF: fixing the Custom WCF Proxy Generator</a> (26/08/2015)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/silverlight-custom-buttons-with-templates">Silverlight: Custom Buttons with Templates</a> (09/01/2008)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/nhibernate-envers-customize-revision-entity">NHibernate.Envers - Customize the Revision Entity</a> (08/05/2011)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/passing-json-serialized-objects-wcf-service-jquery">Passing JSON serialized objects to a WCF service with jQuery</a> (26/08/2015)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/jquery-wcf-json-datetime-serialization">JQuery, WCF and the JSON DateTime serialization</a> (03/04/2010)</li><li style="list-style-type: none"><a href="/Blog/Related/silverlight-wcf-writing-custom-wcf-proxy-generator-support-validation"><strong>More related document (49)</strong></a></li></ul><br />
