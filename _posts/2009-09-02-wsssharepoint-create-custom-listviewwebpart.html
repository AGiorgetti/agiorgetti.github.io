---
layout: post
title: 'WSS/SharePoint: Create a Custom ListViewWebPart'
tags:
- Sharepointwsscustomlistviewwebpart
---

<p>
	The standard ListViewWebPart, while it does a lot of work under the hood, offers quite limited functionalities when it comes to programmatically filter the data: even if you can wire up a filter WebPart that provide multiple values, only the first one will be considered; plus you can set only a single WebPart as the &lsquo;data provider&rsquo; for the ListView (and this makes the realization of complex filter very hard).</p>
<p>
	You can rely on different techniques to accomplish the job:</p>
<p>
	- using SharePoint designer and create custom pages there (but it&rsquo;s like hard coding the things and the reusability is minimal).</p>
<p>
	- you can define a set of views and assign them to different users, but it can be easily done only in MOSS using the Target Audience feature, and you cannot do it in WSS.</p>
<p>
	- other alternatives I do not know...</p>
<p>
	I didn&rsquo;t liked any of these approaches and so I decided to try to customize the ListViewWebPart. You cannot directly inherit from the control (the class itself is marked as &lsquo;sealed&rsquo;, plus it can use many external resources you never know where they can reside given the structure of SharePoint).</p>
<p>
	I started the thing trying to use the original control, but there were problems in the way it handled the views..that is to work correctly it needs to refer to an existing view in the database; but in order to apply a custom filter query to that view, you have to call for the &lsquo;Update&rsquo; method of the view object. If the user do not have the right permission that operation will fail and you&rsquo;ll have an &lsquo;access denied, log with another user&rsquo; (or something similar) error.</p>
<p>
	To overcome this I decided to create a brand new View object based on the schema of the current view (or the view the user have selected) and to call its RenderAsHtml() method; the result is a WebPart that act as the original ListViewWebPart, but that you can easily filter and customize (even in WSS).</p>
<p>
	Here&rsquo;s the code:</p>
<div class="csharpcode-wrapper">
	<div class="csharpcode">
		<pre class="alt">[Guid(<span class="str">&quot;b7ea3f7d-b260-4ce8-9fd0-3af5aee8e0d6&quot;</span>)]</pre><pre class="alteven"><span class="kwrd">public</span> <span class="kwrd">class</span> CustomListViewWebPart : System.Web.UI.WebControls.WebParts.WebPart</pre><pre class="alt">{</pre><pre class="alteven">    <span class="preproc">#region</span> Properties</pre><pre class="alt">&nbsp;</pre><pre class="alteven">    <span class="kwrd">private</span> <span class="kwrd">string</span> strSourceList = <span class="kwrd">string</span>.Empty;</pre><pre class="alt">    <span class="kwrd">private</span> <span class="kwrd">string</span> strViewOfSourceList = <span class="kwrd">string</span>.Empty;</pre><pre class="alteven">    <span class="kwrd">private</span> <span class="kwrd">string</span> strQuery = <span class="kwrd">string</span>.Empty;</pre><pre class="alt">&nbsp;</pre><pre class="alteven">    <span class="rem">/// <summary></summary></span></pre><pre class="alt">    <span class="rem">/// The List we are displaying</span></pre><pre class="alteven">    <span class="rem">/// </span></pre><pre class="alt">    [Personalizable(<span class="kwrd">true</span>),</pre><pre class="alteven">    WebBrowsable(),</pre><pre class="alt">    WebDisplayName(<span class="str">&quot;List Name&quot;</span>),</pre><pre class="alteven">    WebDescription(<span class="str">&quot;Pass the name of the List to show&quot;</span>)]</pre><pre class="alt">    <span class="kwrd">public</span> <span class="kwrd">string</span> SourceList</pre><pre class="alteven">    {</pre><pre class="alt">        get</pre><pre class="alteven">        {</pre><pre class="alt">            <span class="kwrd">return</span> strSourceList;</pre><pre class="alteven">        }</pre><pre class="alt">        set</pre><pre class="alteven">        {</pre><pre class="alt">            strSourceList = <span class="kwrd">value</span>;</pre><pre class="alteven">        }</pre><pre class="alt">    }</pre><pre class="alteven">&nbsp;</pre><pre class="alt">    <span class="rem">/// <summary></summary></span></pre><pre class="alteven">    <span class="rem">/// The Default View of the list</span></pre><pre class="alt">    <span class="rem">/// </span></pre><pre class="alteven">    [Personalizable(<span class="kwrd">true</span>),</pre><pre class="alt">    WebBrowsable(),</pre><pre class="alteven">    WebDisplayName(<span class="str">&quot;View&quot;</span>),</pre><pre class="alt">    WebDescription(<span class="str">&quot;Pass the name of the View that you want to apply to the List&quot;</span>)]</pre><pre class="alteven">    <span class="kwrd">public</span> <span class="kwrd">string</span> ViewOfSourceList</pre><pre class="alt">    {</pre><pre class="alteven">        get</pre><pre class="alt">        {</pre><pre class="alteven">            <span class="kwrd">return</span> strViewOfSourceList;</pre><pre class="alt">        }</pre><pre class="alteven">        set</pre><pre class="alt">        {</pre><pre class="alteven">            strViewOfSourceList = <span class="kwrd">value</span>;</pre><pre class="alt">        }</pre><pre class="alteven">    }</pre><pre class="alt">&nbsp;</pre><pre class="alteven">    <span class="rem">/// <summary></summary></span></pre><pre class="alt">    <span class="rem">/// a CAML query to filter the object</span></pre><pre class="alteven">    <span class="rem">/// </span></pre><pre class="alt">    <span class="rem">/// <remarks></remarks></span></pre><pre class="alteven">    <span class="rem">/// in a later revision we will use one or more filter providers to set this</span></pre><pre class="alt">    <span class="rem">/// </span></pre><pre class="alteven">    [Personalizable(<span class="kwrd">true</span>),</pre><pre class="alt">    WebBrowsable(),</pre><pre class="alteven">    WebDisplayName(<span class="str">&quot;Query&quot;</span>),</pre><pre class="alt">    WebDescription(<span class="str">&quot;Pass the Filter Query&quot;</span>)]</pre><pre class="alteven">    <span class="kwrd">public</span> <span class="kwrd">string</span> FilterQuery</pre><pre class="alt">    {</pre><pre class="alteven">        get</pre><pre class="alt">        {</pre><pre class="alteven">            <span class="kwrd">return</span> strQuery;</pre><pre class="alt">        }</pre><pre class="alteven">        set</pre><pre class="alt">        {</pre><pre class="alteven">            strQuery = <span class="kwrd">value</span>;</pre><pre class="alt">        }</pre><pre class="alteven">    }</pre><pre class="alt">&nbsp;</pre><pre class="alteven">    <span class="preproc">#endregion</span></pre><pre class="alt">&nbsp;</pre><pre class="alteven">    <span class="kwrd">public</span> CustomListViewWebPart()</pre><pre class="alt">    {</pre><pre class="alteven">        <span class="kwrd">this</span>.ExportMode = WebPartExportMode.All;</pre><pre class="alt">    }</pre><pre class="alteven">&nbsp;</pre><pre class="alt">    <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> CreateChildControls()</pre><pre class="alteven">    {</pre><pre class="alt">        <span class="kwrd">base</span>.CreateChildControls();</pre><pre class="alteven">        </pre><pre class="alt">        SPWeb web = SPContext.Current.Web;</pre><pre class="alteven">        {</pre><pre class="alt">            <span class="kwrd">try</span></pre><pre class="alteven">            {</pre><pre class="alt">                SPList list = web.Lists[SourceList];</pre><pre class="alteven">&nbsp;</pre><pre class="alt">                <span class="rem">// create the toolbar, actually we cannot hide it, we&#39;ll need to extend the webpart and those options</span></pre><pre class="alteven">                ViewToolBar toolbar = <span class="kwrd">new</span> ViewToolBar();</pre><pre class="alt">                SPContext context = SPContext.GetContext(<span class="kwrd">this</span>.Context, list.Views[ViewOfSourceList].ID, list.ID, SPContext.Current.Web);</pre><pre class="alteven">                toolbar.RenderContext = context;</pre><pre class="alt">                Controls.Add(toolbar);</pre><pre class="alteven">&nbsp;</pre><pre class="alt">                <span class="rem">// get a reference to the view we want to use</span></pre><pre class="alteven">                SPView webPartView = web.Lists[SourceList].Views[ViewOfSourceList];</pre><pre class="alt">               </pre><pre class="alteven">                <span class="rem">// create a new view based on the original one and attach the filter query to it</span></pre><pre class="alt">                <span class="rem">// in this way we do not need to modify/update the original element and</span></pre><pre class="alteven">                <span class="rem">// even a user without updating permissions can use this webpart</span></pre><pre class="alt">                XmlDocument domDoc = <span class="kwrd">new</span> XmlDocument();</pre><pre class="alteven">                domDoc.LoadXml(webPartView.SchemaXml);</pre><pre class="alt">                SPView view = <span class="kwrd">new</span> SPView(list, domDoc);</pre><pre class="alteven">                view.Query = FilterQuery;</pre><pre class="alt">&nbsp;</pre><pre class="alteven">                <span class="rem">// render the view</span></pre><pre class="alt">                Literal lbl = <span class="kwrd">new</span> Literal();</pre><pre class="alteven">                lbl.Text = view.RenderAsHtml();</pre><pre class="alt">                <span class="kwrd">this</span>.Controls.Add(lbl);</pre><pre class="alteven">            }</pre><pre class="alt">&nbsp;</pre><pre class="alteven">            <span class="kwrd">catch</span> (Exception ex)</pre><pre class="alt">            {</pre><pre class="alteven">                <span class="rem">// todo: have a better way to report errors!</span></pre><pre class="alt">                Label lbl = <span class="kwrd">new</span> Label();</pre><pre class="alteven">                lbl.Text = <span class="str">&quot;Error occured: &quot;</span>;</pre><pre class="alt">                lbl.Text += ex.Message;</pre><pre class="alteven">                <span class="kwrd">this</span>.Controls.Add(lbl);</pre><pre class="alt">            }</pre><pre class="alteven">        }</pre><pre class="alt">    }</pre><pre class="alteven">&nbsp;</pre><pre class="alt">    <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Render(HtmlTextWriter writer)</pre><pre class="alteven">    {</pre><pre class="alt">        EnsureChildControls();</pre><pre class="alteven">        <span class="kwrd">base</span>.Render(writer);</pre><pre class="alt">    }</pre><pre class="alteven">}</pre></div>
</div>
<p>
	To use it, just instantiate it on a page and set the &lsquo;List&rsquo;, &lsquo;View&rsquo; and optionally &lsquo;Query&rsquo; properties to the right values.</p>
<p>
	On the next articles of this series I&rsquo;ll show you how to create custom filters and wire them to an evolved version of this WebPart.</p>
