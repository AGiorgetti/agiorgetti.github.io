---
layout: post
title: NHibernate - Eager Fetch and Pagination in one query
---

<p>Let’s consider these mappings:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:DFDE9937-D816-47f4-A306-7B60D5CE5AC0:c0af5e1b-7614-4d6a-a067-8f89c54e35b6" class="wlWriterEditableSmartContent"><pre class="brush: xml; gutter: false; first-line: 1; tab-size: 4;  toolbar: true; ">&lt;class name=&quot;Item&quot; table=&quot;Item&quot;&gt;
	&lt;id name=&quot;Id&quot; column=&quot;Id&quot; type=&quot;int&quot;&gt;
		&lt;generator class=&quot;native&quot; /&gt;
	&lt;/id&gt;
	&lt;property name=&quot;Name&quot; column=&quot;Name&quot; type=&quot;string&quot; /&gt;
	&lt;property name=&quot;Sort&quot; column=&quot;Sort&quot; type=&quot;int&quot; /&gt;
	&lt;bag name=&quot;Tags&quot; inverse=&quot;true&quot; lazy=&quot;true&quot;&gt;
		&lt;key column=&quot;ItemId&quot; /&gt;
		&lt;one-to-many class=&quot;Tag&quot;/&gt;
	&lt;/bag&gt;
&lt;/class&gt;

&lt;class name=&quot;Tag&quot; table=&quot;Tag&quot;&gt;
	&lt;id name=&quot;Id&quot; column=&quot;Id&quot; type=&quot;int&quot;&gt;
		&lt;generator class=&quot;native&quot; /&gt;
	&lt;/id&gt;
	&lt;property name=&quot;Name&quot; column=&quot;Name&quot; type=&quot;string&quot; not-null=&quot;true&quot; /&gt;
	&lt;many-to-one name=&quot;Item&quot; column=&quot;ItemId&quot; class=&quot;Item&quot; not-null=&quot;true&quot; /&gt;
&lt;/class&gt;
</pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>

<p>&#160;</p>

<p>Trying to paginate a query that uses eager fetching to retrieve the data in the ‘traditional’ way, that is using something similar to this piece of code:</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:DFDE9937-D816-47f4-A306-7B60D5CE5AC0:8e53687d-7d89-4501-a07a-abd3f9f46f0a" class="wlWriterEditableSmartContent"><pre class="brush: csharp; gutter: false; first-line: 1; tab-size: 4;  toolbar: true; ">ICriteria myCriteria = session.CreateCriteria&lt;Item&gt;(&quot;itm&quot;);
myCriteria.AddOrder(new Order(&quot;Sort&quot;, true))
	.SetFirstResult((pageIndex - 1)*pageSize)
	.SetMaxResults(pageSize)
	.SetResultTransformer(Transformers.DistinctRootEntity)
	.SetFetchMode(&quot;Tags&quot;, FetchMode.Eager);</pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>

<p>&#160;</p>

<p>Will simply FAIL, because eager fetching retrieves more data rows from the database due to the joins it performs, thus the ‘SetFirstResult()’ call will simply cut out some of your data.</p>

<p>One way to resolve the problem is to use a DetachedCriteria to actually get a projection of all the Ids of the items you want to paginate (applying any filtering and sorting you desire at this step) and later on use the projection to perform the real query that retrieves the data using eager fetching:</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:DFDE9937-D816-47f4-A306-7B60D5CE5AC0:4810ca9d-1220-4619-a727-9211615fbf42" class="wlWriterEditableSmartContent"><pre class="brush: csharp; gutter: false; first-line: 1; tab-size: 4;  toolbar: true; ">private static IList&lt;Item&gt; GetPagedData(int pageIndex, int pageSize)
{
	IList&lt;Item&gt; result;
	using (ISession session = NHelper.OpenSession())
	using (ITransaction tx = session.BeginTransaction())
	{
		// get the list of IDs corresponding to the page od data we wanna get
		DetachedCriteria detached = DetachedCriteria.For&lt;Item&gt;(&quot;itm2&quot;);
		detached.AddOrder(new Order(&quot;Sort&quot;, true))
			.SetFirstResult((pageIndex - 1)*pageSize)
			.SetMaxResults(pageSize)
			.SetProjection(Projections.Property(&quot;Id&quot;));
		// get the real data
		ICriteria myCriteria = session.CreateCriteria&lt;Item&gt;(&quot;itm&quot;);

		myCriteria
			.Add(Subqueries.PropertyIn(&quot;Id&quot;, detached))
			.SetResultTransformer(Transformers.DistinctRootEntity)
			.SetFetchMode(&quot;Tags&quot;, FetchMode.Eager);
			
		result = myCriteria.List&lt;Item&gt;();

		tx.Commit();
	}
	return result;
}</pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>

<p>&#160;</p>

<p>If you look at the logs generated by NHibernate you will see that this code will result in a single query sent to your database engine, having called this function asking for page index 2 with a page size of 2 I obtain the following query:</p>

<p>SELECT this_.Id as Id1_1_, this_.Name as Name1_1_, this_.Sort as Sort1_1_, tags2_.ItemId as ItemId3_, tags2_.Id as Id3_, tags2_.Id as Id0_0_, tags2_.Name as Name0_0_, tags2_.ItemId as ItemId0_0_ FROM dbo.Item this_ left outer join dbo.Tag tags2_ on this_.Id=tags2_.ItemId WHERE this_.Id in (SELECT TOP 2 y0_ FROM (SELECT this_0_.Id as y0_, ROW_NUMBER() OVER(ORDER BY this_0_.Sort) as __hibernate_sort_row FROM dbo.Item this_0_) as query WHERE query.__hibernate_sort_row &gt; 2 ORDER BY query.__hibernate_sort_row)</p>

<p>This technique helped me to reduce the number of queries made by the application a lot. 
  </p><h2>Related Content</h2><ul><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/nhibernate-eager-fetch-order-strange-behavior-icriteria">NHibernate - Eager Fetch, Order By and a strange behavior with ICriteria</a> (26/08/2015)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/wpf-generic-serverside-pagination-data-provider">WPF: a generic ‘server-side’ pagination data provider</a> (26/08/2015)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/silverlight-pagination-control-bug-fixed">Silverlight Pagination Control – bug fixed</a> (26/08/2015)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/silverlight-a-generic-pagination-control">Silverlight: a generic Pagination Control</a> (09/08/2008)</li><li style="list-style-type: none"><a href="http://www.primordialcode.com/blog/post/breaking-news-european-nhibernate-day-officially-announced">Breaking news: the First European NHibernate Day had been officially announced</a> (26/08/2015)</li><li style="list-style-type: none"><a href="/Blog/Related/nhibernate-eager-fetch-pagination-query"><strong>More related document (24)</strong></a></li></ul><br />
